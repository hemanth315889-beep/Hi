<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Mobile File Manager</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4ade80;
            --background-color: #000000;
            --surface-color: #1a1a1a;
            --text-color: #e5e5e5;
            --text-light: #a3a3a3;
            --border-color: #404040;
            --shadow: 0 0 10px rgba(74, 222, 128, 0.3);
            --border-radius: 0;

            /* --- File & Folder Colors --- */
            --danger-color: #f43f5e;
            --folder-color: #38bdf8;
            --file-color: #e5e5e5;
            --exec-color: #4ade80;
            --image-color: #facc15;
            --archive-color: #94a3b8;
            --video-color: #a78bfa;

            /* --- Language & Script Colors --- */
            --code-c-color: #c084fc;
            --code-html-color: #f43f5e;
            --code-css-color: #60a5fa;
            --code-js-color: #facc15;
            --code-py-color: #2dd4bf;
            --script-color: #22d3ee;
        }

        * {
            margin: 0; padding: 0; box-sizing: border-box;
            font-family: 'Roboto Mono', monospace;
            -webkit-tap-highlight-color: transparent;
        }

        body { background-color: var(--background-color); color: var(--text-color); height: 100vh; overflow: hidden; padding: 1rem; }
        .container { display: flex; flex-direction: column; height: 100%; width: 100%; background-color: var(--surface-color); position: relative; border: 1px solid var(--border-color); }
        .main-content { flex-grow: 1; position: relative; overflow: hidden; }
        .file-list { list-style: none; padding: 1rem; margin: 0; height: 100%; overflow-y: auto; }
        .file-list-item { display: flex; align-items: center; }
        .item-icon { width: 20px; text-align: center; margin-right: 1rem; }
        .item-name { flex-grow: 1; }
        .item-actions { display: flex; }
        .action-btn { font-size: 1.25rem; color: var(--text-light); }
        .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background-color: var(--surface-color); z-index: 1001; box-shadow: var(--shadow); padding: 20px; display: flex; flex-direction: column; transform: translateX(-100%); transition: transform 0.3s ease-in-out; }
        .sidebar.open { transform: translateX(0); }
        .sidebar-logo { display: flex; align-items: center; gap: 10px; font-size: 1.5rem; font-weight: 600; color: var(--primary-color); margin-bottom: 30px; padding-left: 10px; }
        .sidebar-nav a, .sidebar-nav button { display: flex; align-items: center; width: 100%; padding: 12px 15px; margin-bottom: 8px; border-radius: 8px; text-decoration: none; color: var(--text-light); font-weight: 500; transition: background-color 0.2s, color 0.2s; background: none; border: none; cursor: pointer; font-size: 1rem; font-family: inherit; text-align: left; }
        .sidebar-nav i { width: 30px; font-size: 1.1rem; }
        .sidebar-nav a:hover, .sidebar-nav button:hover { background-color: #e9f2fe; color: var(--primary-color); }
        .sidebar-nav button.active { background-color: var(--primary-color); color: white; }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; opacity: 0; pointer-events: none; transition: opacity 0.3s ease-in-out; }
        .sidebar-overlay.open { opacity: 1; pointer-events: auto; }
        .fab { position: absolute; bottom: 1.5rem; right: 1.5rem; width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary-color); color: white; border: none; font-size: 1.75rem; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.25); transition: all 0.2s ease-in-out; z-index: 10; }
        .fab:hover { transform: scale(1.05); }
        .status-bar { padding: 0.25rem 1rem; font-size: 0.8rem; flex-shrink: 0; text-align: center; color: var(--text-light); background-color: var(--background-color); }
        .loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(2px); display: none; align-items: center; justify-content: center; z-index: 2000; color: var(--primary-color); font-size: 1.5rem; font-weight: 500; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 1002; }
        .modal-dialog { background-color: var(--surface-color); padding: 1.5rem; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.5); width: 90%; max-width: 350px; }
        .modal-title { margin-top: 0; margin-bottom: 1.5rem; font-size: 1.25rem; font-weight: 500; }
        .modal-input { width: 100%; padding: 0.75rem; background: var(--background-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1rem; margin-bottom: 1.5rem; }
        .modal-input:focus { outline: none; border-color: var(--primary-color); }
        .modal-actions { display: flex; justify-content: flex-end; gap: 0.5rem; }
        .modal-btn { background: transparent; border: none; cursor: pointer; padding: 0.6rem 1rem; border-radius: 6px; font-weight: 600; font-size: 0.9rem; text-transform: uppercase; transition: background-color 0.2s; }
        .modal-btn.cancel { color: var(--primary-color); }
        .modal-btn.create, .modal-btn.danger { background-color: var(--primary-color); color: white; }
        .modal-btn.danger { background-color: var(--danger-color); }
        .bottom-bar { position: absolute; bottom: 0; left: 0; right: 0; background-color: var(--surface-color); padding: 0.75rem 1rem; display: none; align-items: center; justify-content: space-between; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 11; }
        .bottom-bar-btn { color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .bottom-bar-btn.paste-btn { background-color: var(--primary-color); }
        .bottom-bar-btn.cancel-btn { background-color: var(--text-light); }
        .multi-select-bar { justify-content: space-around; }
        .multi-select-bar .icon-btn { color: var(--text-color); width: 65px; height: 55px; border-radius: 12px; flex-direction: column; font-size: 1.25rem; gap: 4px; }
        .multi-select-bar .icon-btn span { font-size: 0.7rem; font-weight: 500; }

        .editor-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--background-color);
            z-index: 1100; display: flex; flex-direction: column;
            transform: translateX(100%); transition: transform 0.3s ease-in-out;
        }
        .editor-view.open { transform: translateX(0); }
        .editor-bar {
            padding: 0.5rem 0.75rem; background-color: var(--surface-color);
            flex-shrink: 0; display: flex; align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .editor-filename {
            flex-grow: 1; font-size: 1.1rem; font-weight: 600;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin: 0 1rem;
        }
        .save-btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 0.5rem 1rem; border-radius: 8px; font-size: 1rem;
            font-weight: 600; cursor: pointer; display: flex;
            align-items: center; gap: 8px; transition: background-color 0.2s;
        }
        .save-btn:hover { background-color: #1e61d1; }
        .editor-textarea {
            flex-grow: 1; width: 100%; border: none; outline: none; resize: none;
            padding: 1rem; font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
            font-size: 1rem; line-height: 1.5; color: var(--text-color);
            background-color: var(--background-color);
        }
    </style>
</head>
<body>

<div class="container">
    <main class="main-content">
        <ul class="file-list" id="fileList"></ul>
    </main>
    <div class="command-line">
        <span id="prompt"></span>
        <input type="text" id="commandInput" class="command-input">
    </div>
</div>

<div class="loader" id="loader"><i class="fa-solid fa-spinner fa-spin"></i></div>

<div class="modal-overlay" id="modalOverlay">
    <div class="modal-dialog" id="createModal">
        <h3 class="modal-title">Create New Item</h3>
        <div style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem;"><label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;"><input type="radio" name="createType" value="file" checked> File</label><label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;"><input type="radio" name="createType" value="folder"> Folder</label></div>
        <input type="text" class="modal-input" id="modalNewNameInput" placeholder="Enter name..."><div class="modal-actions"><button class="modal-btn cancel" id="modalCancelBtn">Cancel</button><button class="modal-btn create" id="modalCreateBtn">Create</button></div>
    </div>
    <div class="modal-dialog" id="renameModal">
        <h3 class="modal-title" id="renameModalTitle">Rename</h3>
        <input type="text" class="modal-input" id="renameInput" placeholder="Enter new name..."><div class="modal-actions"><button class="modal-btn cancel" id="renameCancelBtn">Cancel</button><button class="modal-btn create" id="renameConfirmBtn">Rename</button></div>
    </div>
    <div class="modal-dialog" id="confirmModal">
        <h3 class="modal-title" id="confirmModalTitle">Confirm Action</h3>
        <p id="confirmModalText" style="margin-bottom: 1.5rem; line-height: 1.5;"></p><div class="modal-actions"><button class="modal-btn cancel" id="confirmCancelBtn">Cancel</button><button class="modal-btn danger" id="confirmConfirmBtn">Confirm</button></div>
    </div>
</div>

<div class="editor-view" id="editorView">
    <header class="editor-bar">
        <button class="icon-btn" id="closeEditorBtn"><i class="fa-solid fa-arrow-left"></i></button>
        <h2 class="editor-filename" id="editorFilename"></h2>
        <button class="save-btn" id="saveFileBtn"><i class="fa-solid fa-save"></i> Save</button>
    </header>
    <textarea class="editor-textarea" id="editorTextarea" spellcheck="false"></textarea>
</div>


<script>
    const API_BASE = 'http://localhost:8080', TERMUX_HOME_PATH = '/data/data/com.termux/files/home', SDCARD_PATH = '/sdcard';
    const fileListEl = document.getElementById('fileList'), loader = document.getElementById('loader');
    const commandInput = document.getElementById('commandInput'), promptEl = document.getElementById('prompt');

    let currentPath = TERMUX_HOME_PATH, showHiddenFiles = false;
    function formatBytes(bytes, decimals = 2) { if (!bytes || bytes === 0) return '0 B'; const k = 1024; const dm = decimals < 0 ? 0 : decimals; const sizes = ['B', 'KB', 'MB', 'GB', 'TB']; const i = Math.floor(Math.log(bytes) / Math.log(k)); return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i]; }

    function getIconDetails(name, type) {
        if (type === 'folder') {
            return { icon: 'fa-solid fa-folder', color: 'var(--folder-color)' };
        }

        if (!name.includes('.')) {
            return { icon: 'fa-solid fa-file-lines', color: 'var(--script-color)' };
        }

        const extension = name.split('.').pop().toLowerCase();
        switch (extension) {
            case 'pdf': return { icon: 'fa-solid fa-file-pdf', color: 'var(--danger-color)' };
            case 'mp4': case 'mkv': case 'mov': case 'avi': case 'webm': return { icon: 'fa-solid fa-file-video', color: 'var(--video-color)' };
            case 'png': case 'jpg': case 'jpeg': case 'gif': case 'webp': case 'svg': case 'bmp': return { icon: 'fa-solid fa-file-image', color: 'var(--image-color)' };
            case 'zip': case 'rar': case '7z': case 'tar': case 'gz': return { icon: 'fa-solid fa-file-zipper', color: 'var(--archive-color)' };
            case 'c': case 'cpp': case 'cs': return { icon: 'fa-solid fa-file-code', color: 'var(--code-c-color)' };
            case 'html': return { icon: 'fa-solid fa-file-code', color: 'var(--code-html-color)' };
            case 'css': return { icon: 'fa-solid fa-file-code', color: 'var(--code-css-color)' };
            case 'js': return { icon: 'fa-solid fa-file-code', color: 'var(--code-js-color)' };
            case 'py': return { icon: 'fa-solid fa-file-code', color: 'var(--code-py-color)' };
            case 'rb': return { icon: 'fa-solid fa-file-code', color: 'var(--danger-color)' };
            case 'sh': case 'bash': return { icon: 'fa-solid fa-file-lines', color: 'var(--script-color)' };
            default: return { icon: 'fa-solid fa-file', color: 'var(--primary-color)' };
        }
    }

    async function fetchAndRenderFiles() {
        try {
            const response = await apiRequest('/list');
            currentPath = response.path;
            const allFiles = response.files.sort((a, b) => (a.type === b.type) ? a.name.localeCompare(b.name) : (a.type === 'folder' ? -1 : 1));
            const files = showHiddenFiles ? allFiles : allFiles.filter(item => !item.name.startsWith('.'));

            promptEl.textContent = `${currentPath}$`;

            fileListEl.innerHTML = files.map(item => {
                const details = getIconDetails(item.name, item.type);
                const itemClass = item.type === 'folder' ? 'folder' : 'file';
                const execIndicator = item.is_executable ? '*' : '';
                return `<li class="file-list-item">
                    <span class="item-icon"><i class="${details.icon}" style="color: ${details.color};"></i></span>
                    <span class="item-name ${itemClass}" onclick="handleItemClick('${item.name}', '${item.type}')">${item.name}${execIndicator}</span>
                </li>`;
            }).join('');

        } catch (error) {
            fileListEl.innerHTML = `<li>Error: ${error.message}</li>`;
        }
    }

    function handleItemClick(name, type) {
        if (type === 'folder') {
            navigateTo(name);
        } else {
            // Potentially open in editor, for now, just log it
            console.log(`Clicked on file: ${name}`);
        }
    }

    function handleCommand(e) {
        if (e.key !== 'Enter') return;
        const command = commandInput.value.trim();
        commandInput.value = '';

        const [cmd, ...args] = command.split(' ');

        switch(cmd) {
            case 'cd':
                if (args.length > 0) {
                    const newPath = args[0];
                    if (newPath === '..') {
                        navigateUp();
                    } else {
                        navigateTo(newPath);
                    }
                }
                break;
            case 'ls':
                showHiddenFiles = args.includes('-a');
                fetchAndRenderFiles();
                break;
            case 'clear':
                fileListEl.innerHTML = '';
                break;
            default:
                fileListEl.innerHTML += `<li>-bash: ${command}: command not found</li>`;
        }
    }

    function showLoader(show) { loader.style.display = show ? 'flex' : 'none'; }
    async function apiRequest(endpoint, options = {}) {
        if (!['/read', '/write'].includes(endpoint)) showLoader(true);
        try {
            const headers = { ...options.headers };
            if (currentPath !== null) headers['X-Current-Path'] = currentPath;
            if (options.method === 'POST' && options.body && options.body.constructor.name !== 'FormData') headers['Content-Type'] = 'application/json';
            const response = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
            const responseData = await response.json().catch(() => ({ message: response.statusText }));
            if (!response.ok) {
                const errorMessage = (typeof responseData === 'object' && responseData.message) ? responseData.message : responseData;
                throw new Error(errorMessage || `Server error: ${response.status}`);
            }
            return responseData;
        } finally {
            showLoader(false);
        }
    }
    function navigateTo(folderName) { currentPath = (currentPath === '/') ? `/${folderName}` : `${currentPath}/${folderName}`; fetchAndRenderFiles(); }
    function navigateUp() { if (currentPath === "/") return; currentPath = currentPath.substring(0, currentPath.lastIndexOf('/')) || '/'; fetchAndRenderFiles(); }

    commandInput.addEventListener('keydown', handleCommand);
    document.addEventListener('DOMContentLoaded', fetchAndRenderFiles);
</script>
</body>
</html>
